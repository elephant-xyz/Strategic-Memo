name: convert

on:
  push:
    paths:
      - '**.tex'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc

      - name: Create output directory
        run: mkdir -p output

      - name: Convert .tex files to Markdown with YAML frontmatter
        run: |
          for file in *.tex; do
            base=$(basename "$file" .tex)
            
            # Try to extract chapter or section title
            raw_title=$(grep -m1 -E '\\chapter\{.*\}|\\section\{.*\}' "$file" | sed -E 's/\\(chapter|section)\{(.*)\}/\2/' | head -n1)

            # Fallback to base filename if no title found
            title="${raw_title:-$base}"

            # Slugify title (lowercase, replace spaces with hyphens, remove special chars)
            slug=$(echo "$title" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g' | sed -E 's/^-+|-+$//g')

            # Escape YAML-unfriendly characters in title
            safe_title=$(echo "$title" | sed 's/["'\''\\]/ /g')

            # Write frontmatter and convert .tex content
            {
              echo "---"
              echo "title: \"$safe_title\""
              echo "slug: \"$slug\""
              echo "toc: true"
              echo "---"
              echo ""
            } > "output/$base.md"

            pandoc "$file" -f latex -t markdown --wrap=none >> "output/$base.md" || echo "❌ Failed to convert $file"
          done

      - name: Combine all .md files into one document
        run: |
          mkdir -p output_tmp
          find output -type f -name '*.md' ! -name 'Full_Doc.md' -exec cat {} + > output_tmp/Full_Doc.md
          mv output_tmp/Full_Doc.md output/Full_Doc.md

      - name: Upload converted markdown files
        uses: actions/upload-artifact@v4
        with:
          name: converted-markdown
          path: output/
