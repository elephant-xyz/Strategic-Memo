name: Convert .tex to Markdown

on:
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install pandoc
        run: sudo apt-get update && sudo apt-get install -y pandoc

      - name: Debug title extraction from .tex files
        run: |
          echo "ðŸ“„ Listing .tex files:"
          ls -l *.tex

          echo "ðŸ” Extracting LaTeX titles (\\chapter{} or \\section{}):"
          grep -H -E '\\(chapter|section)\{.*\}' *.tex || echo "No titles found"

      - name: Split and Convert .tex files to Markdown
        run: |
          mkdir -p output
          for file in *.tex; do
            base=$(basename "$file" .tex)
            awk '
              BEGIN {n=0; outfile="output/" n "_" FILENAME; print "ðŸ“¤ Converting " FILENAME " â†’ " outfile > "/dev/stderr"}
              /^\\(chapter|section)\{/ {
                close(outfile)
                n+=1
                outfile=sprintf("output/%d_%s.md", n, FILENAME)
              }
              {
                gsub(/\\/, "\\\\")  # Escape LaTeX backslashes for YAML safety
                print > outfile
              }
            ' "$file"
          done

      - name: Combine into Full Doc
        run: |
          echo "ðŸ§© Combining all .md files into output/Full Doc.md"
          find output -name '*.md' ! -name 'Full Doc.md' -exec cat {} + > "output/Full Doc.md"

      - name: Post-run debug for markdown output
        run: ls -lh output/
