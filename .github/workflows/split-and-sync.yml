name: 📄 Safe LaTeX to Markdown Conversion

on:
  push:
    paths:
      - '**.tex'
      - '.github/workflows/split-and-sync.yml'

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v3

      - name: 🧰 Install pandoc
        run: sudo apt-get update && sudo apt-get install -y pandoc

      - name: 🧪 Debug title extraction from .tex files
        run: |
          echo "📂 Listing .tex files:"
          ls -l *.tex

          echo "🔍 Extracting LaTeX titles (\\chapter{} or \\section{}):"
          grep -Eo '\\(chapter|section)\{[^}]+\}' *.tex || echo "⚠️ No matches found"

      - name: 🔄 Split and Convert .tex Files
        run: |
          mkdir -p output

          for tex_path in *.tex; do
            base_name=$(basename "$tex_path" .tex)
            output_file="output/${base_name}.md"

            echo "🔧 Converting $tex_path to $output_file"

            # Extract title from first \chapter{} or \section{} line
            raw_title=$(grep -Eo '\\(chapter|section)\{[^}]+\}' "$tex_path" | head -n 1 | sed -E 's/\\(chapter|section)\{//; s/}//')

            if [ -z "$raw_title" ]; then
              raw_title="$base_name"
            fi

            # Escape YAML-sensitive characters
            safe_title=$(printf '%s' "$raw_title" | sed 's/["&:]/\\&/g')

            # Convert LaTeX to Markdown
            pandoc "$tex_path" -f latex -t markdown_strict --wrap=preserve -o "$output_file"

            # Add frontmatter
            tmp_file=$(mktemp)
            echo "---" > "$tmp_file"
            echo "title: \"$safe_title\"" >> "$tmp_file"
            echo "source: \"$tex_path\"" >> "$tmp_file"
            echo "---" >> "$tmp_file"
            echo "" >> "$tmp_file"
            cat "$output_file" >> "$tmp_file"
            mv "$tmp_file" "$output_file"

            echo "✅ Done: $output_file"
          done
