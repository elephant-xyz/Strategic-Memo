name: Split and Convert LaTeX Files with Frontmatter

on:
  workflow_dispatch:  # Manual run button in GitHub UI

jobs:
  split-and-convert:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repo
        uses: actions/checkout@v3

      - name: 🧰 Install Pandoc
        run: sudo apt-get install pandoc -y

      - name: 🧹 Clean previous output
        run: rm -rf output && mkdir output

      - name: 📝 Split and Convert .tex files to Markdown
        run: |
          for tex_path in *.tex; do
            filename=$(basename "$tex_path" .tex)
            chapter_dir="output/$filename"
            mkdir -p "$chapter_dir"

            # Split sections at \section using awk
            awk -v prefix="$chapter_dir/section_" '
              BEGIN {n=0; file="";}
              /^\\section/ {
                n++;
                file=sprintf("%s%02d.tex", prefix, n);
                print $0 > file;
                next;
              }
              {
                if (file != "") print $0 >> file;
              }
            ' "$tex_path"

            for splitfile in "$chapter_dir"/section_*.tex; do
              section_title=$(grep -m1 '\\section' "$splitfile" | sed -E 's/\\section(\[[^]]*\])?\{([^}]+)\}/\2/')
              
              # Clean LaTeX-style escapes for YAML compatibility
              clean_title=$(echo "$section_title" | sed 's/\\&/\&/g' | sed 's/\\%/%/g' | sed 's/\\\$/$/g')
              
              slug=$(echo "$clean_title" | tr '[:upper:]' '[:lower:]' | sed 's/ /-/g' | sed 's/[^a-z0-9-]//g')
              order=$(basename "$splitfile" .tex | sed 's/section_//')
              mdfile="$chapter_dir/$slug.md"

              {
                echo "---"
                echo "title: \"$clean_title\""
                echo "slug: \"$slug\""
                echo "parent_slug: \"$filename\""
                echo "type: \"section\""
                echo "order: $order"
