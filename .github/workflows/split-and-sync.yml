name: âœï¸ Split and Convert .tex files to Markdown

on:
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Repo
        uses: actions/checkout@v3

      - name: ðŸ› ï¸ Set Up Pandoc
        run: sudo apt-get install -y pandoc

      - name: ðŸ“„ Create Output Folder
        run: mkdir -p output

      - name: âœï¸ Split and Convert .tex files to Markdown
        run: |
          for tex_path in *.tex; do
            slug=$(basename "$tex_path" .tex | sed 's/ /-/g' | tr '[:upper:]' '[:lower:]')
            title=$(head -n 1 "$tex_path" | sed 's/^% *//;s/"/\\"/g')

            pandoc "$tex_path" \
              -f latex -t markdown \
              --wrap=preserve \
              -o "output/$slug.md"

            # Remove mid-paragraph line breaks
            sed -i ':a;N;$!ba;s/\([^\n]\)\n\([^\n]\)/\1 \2/g' "output/$slug.md"

            # Add frontmatter
            {
              echo "---"
              echo "title: \"$title\""
              echo "slug: \"$slug\""
              echo "---"
              echo ""
              cat "output/$slug.md"
            } > "output/temp.md" && mv "output/temp.md" "output/$slug.md"
          done

      - name: ðŸš€ Commit and Push Output
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add output/*.md
          git commit -m "ðŸ“„ Convert .tex to markdown with formatting"
          git push
