name: Convert .tex to Markdown

on:
  push:
    paths:
      - '**.tex'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install pandoc
        run: sudo apt-get update && sudo apt-get install -y pandoc

      - name: Debug title extraction from .tex files
        run: |
          echo "ðŸ§ª Listing .tex files:"
          ls *.tex
          echo "ðŸ“¦ Extracting LaTeX titles (\\chapter{} or \\section{}):"
          grep -E '\\(chapter|section)\{.*\}' *.tex || true

      - name: Split and Convert .tex files to Markdown
        run: |
          mkdir -p output
          for file in *.tex; do
            base=$(basename "$file" .tex)
            title=$(grep -E '\\(chapter|section)\{.*\}' "$file" | head -n 1 | sed -E 's/.*\\(chapter|section)\{([^}]*)\}.*/\2/' || echo "$base")
            echo -e "---\ntitle: |\n  \\${title}\n---\n" > "output/${base}.md"
            pandoc "$file" -f latex -t markdown >> "output/${base}.md"
          done

      - name: Combine into Full Doc
        run: |
          echo "Combining all .md files into output/Full_Doc.md"
          mkdir -p output
          find output -type f -name '*.md' ! -name 'Full_Doc.md' -exec cat {} + > output/tmp.md
          mv output/tmp.md output/Full_Doc.md

      - name: Upload converted Markdown files
        uses: actions/upload-artifact@v3
        with:
          name: converted-md
          path: output/*.md
