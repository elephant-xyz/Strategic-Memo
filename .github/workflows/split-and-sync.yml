name: 📄 Split and Convert .tex files to Markdown

on:
  push:
    paths:
      - '**.tex'
      - '.github/workflows/split-and-sync.yml'

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v3

      - name: 🧰 Install pandoc
        run: sudo apt-get update && sudo apt-get install -y pandoc

      - name: 📝 Split and Convert .tex files with Frontmatter
        run: |
          mkdir -p output

          for tex_path in *.tex; do
            base_name=$(basename "$tex_path" .tex)
            output_file="output/${base_name}.md"

            echo "📦 Converting $tex_path → $output_file"

            # Extract plain text from \chapter{} or \section{} (remove LaTeX syntax)
            raw_title=$(grep -Eo '\\(chapter|section)\{[^}]+\}' "$tex_path" | head -n 1 | sed -E 's/\\(chapter|section)\{([^}]*)\}/\2/')

            # Fallback title if none found
            if [ -z "$raw_title" ]; then
              raw_title="$base_name"
            fi

            # Escape YAML-sensitive characters
            escaped_title=$(printf '%s' "$raw_title" | sed 's/"/\\"/g; s/&/\\&/g')

            # Convert to Markdown using pandoc
            pandoc "$tex_path" -f latex -t markdown_strict --wrap=preserve -o "$output_file"

            # Add YAML frontmatter
            tmp_file=$(mktemp)
            echo "---" > "$tmp_file"
            echo "title: \"$escaped_title\"" >> "$tmp_file"
            echo "source: \"$tex_path\"" >> "$tmp_file"
            echo "---" >> "$tmp_file"
            echo "" >> "$tmp_file"
            cat "$output_file" >> "$tmp_file"
            mv "$tmp_file" "$output_file"

            echo "✅ Finished: $output_file"
          done
