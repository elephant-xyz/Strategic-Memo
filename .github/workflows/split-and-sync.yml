# .github/workflows/split-and-sync.yml

name: ✏️ Split and Convert .tex files to Markdown

on:
  push:
    paths:
      - '**.tex'
  workflow_dispatch:

jobs:
  convert-and-sync:
    runs-on: ubuntu-latest
    steps:
      - name: ↓ Checkout repository
        uses: actions/checkout@v4

      - name: 🔧 Set up Pandoc
        run: |
          sudo apt-get update && sudo apt-get install pandoc -y

      - name: 🌍 Set output directory
        run: |
          mkdir -p output

      - name: ✏️ Split and Convert .tex Files with Frontmatter
        run: |
          for tex_path in *.tex; do
            filename=$(basename "$tex_path" .tex)
            md_path="output/$filename.md"
            echo "Converting $tex_path to $md_path"
            pandoc "$tex_path" -f latex -t markdown -o "$md_path" || echo "Warning: Pandoc failed on $tex_path"
            if [ -f "$md_path" ]; then
              # Generate a safe frontmatter title from filename
              title=$(basename "$filename" | sed 's/_/ /g' | sed 's/\\//g')
              echo "---" > temp.md
              echo "title: \"$title\"" >> temp.md
              echo "source_file: \"$tex_path\"" >> temp.md
              echo "---" >> temp.md
              echo "" >> temp.md

              # Process the file content to remove excess line breaks and escape LaTeX
              awk 'BEGIN{ORS=" "} {gsub(/\\\\/, "\\\\\\\\"); gsub(/\\&/, "&"); print}' "$md_path" >> temp.md
              echo "" >> temp.md

              mv temp.md "$md_path"
            fi
          done

      - name: 🔁 Commit and Push Output
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add output/*.md
          git commit -m "✏️ Auto-converted LaTeX files to Markdown" || echo "No changes to commit."
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
