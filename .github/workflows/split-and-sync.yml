name: 📝 Split and Convert .tex files to Markdown

on:
  push:
    paths:
      - '**.tex'
      - '.github/workflows/split-and-sync.yml'

jobs:
  convert-and-sync:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v3

      - name: 🧪 Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 🛠️ Install Pandoc and pyyaml
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc
          pip install pyyaml

      - name: 📂 Split and Convert .tex files to Markdown
        run: |
          mkdir -p output
          for tex_path in *.tex; do
            filename=$(basename -- "$tex_path")
            filename_noext="${filename%.*}"
            output_file="output/${filename_noext}.md"

            echo "Processing $tex_path → $output_file"

            # Extract title from \\chapter{} or \\section{}, strip LaTeX formatting
            title=$(grep -o '\\\\\(chapter\|section\){[^}]*}' "$tex_path" | head -n 1 | sed 's/\\\\\(chapter\|section\){//;s/}//')
            title=$(echo "$title" | sed 's/\\\\/&/g' | sed 's/&/\\&/g')  # escape ampersands safely

            echo "---" > "$output_file"
            echo "title: \"${title}\"" >> "$output_file"
            echo "source: $tex_path" >> "$output_file"
            echo "---" >> "$output_file"

            # Convert .tex to Markdown
            pandoc "$tex_path" -f latex -t markdown_strict --wrap=none >> "$output_file" || echo "⚠️ Warning converting $tex_path"
          done

      - name: 🚀 Commit and Push Output Files
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add output/*.md
          git diff --cached --quiet || git commit -m "Auto-converted .tex files to Markdown with frontmatter"
          git push
