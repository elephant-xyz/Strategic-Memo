name: 📄 Split and Convert .tex files to Markdown

on:
  push:
    paths:
      - '**.tex'
      - '.github/workflows/split-and-sync.yml'

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v3

      - name: 🧰 Install pandoc
        run: sudo apt-get update && sudo apt-get install -y pandoc

      - name: 📝 Split and Convert .tex files with Frontmatter
        run: |
          mkdir -p output

          for tex_path in *.tex; do
            base_name=$(basename "$tex_path" .tex)
            output_file="output/${base_name}.md"

            # Extract plain title from \chapter{} or \section{}
            raw_title=$(grep -o '\\\(chapter\|section\){[^}]*}' "$tex_path" | head -n 1)
            clean_title=$(echo "$raw_title" | sed -E 's/\\(chapter|section)//; s/[{}]//g')

            # Escape YAML-sensitive characters
            escaped_title=$(printf '%s' "$clean_title" | sed 's/"/\\"/g; s/&/\\&/g')

            # Convert to Markdown
            pandoc "$tex_path" -o "$output_file" --wrap=preserve

            # Prepend YAML frontmatter
            tmp_file=$(mktemp)
            echo "---" > "$tmp_file"
            echo "title: \"$escaped_title\"" >> "$tmp_file"
            echo "source: \"$tex_path\"" >> "$tmp_file"
            echo "---" >> "$tmp_file"
            echo "" >> "$tmp_file"
            cat "$output_file" >> "$tmp_file"
            mv "$tmp_file" "$output_file"

            echo "✅ Converted $tex_path -> $output_file"
          done
