name: convert

on:
  push:
    paths:
      - '**.tex'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up output folder
        run: mkdir -p output

      - name: Convert LaTeX to Markdown
        run: |
          for base in $(ls *.tex | sed -E 's/(_v[0-9]+)?\.tex$//' | sort -u); do
            versions=$(ls ${base}*.tex 2>/dev/null | sort -V)
            latest=$(echo "$versions" | tail -n1)
            prefix=$(echo "$base" | grep -o '^[0-9]\+')
            parent_slug=$(echo "$base" | tr '[:upper:]' '[:lower:]' | tr '_' '-' | sed 's/[^a-z0-9-]//g')

            awk -v parent_slug="$parent_slug" -v file_name="$latest" '
              BEGIN { section = 0; outfile = "" }
              /^\s*\\chapter\{/ {
                chapter = gensub(/^.*\\chapter\{([^}]*)\}.*$/, "\\1", "g")
                introfile = "output/" file_name "_intro.md"
                print "---\ntitle: \"" chapter "\"\nslug: \"" tolower(parent_slug) "\"\nparent_slug: \"\"\ntype: \"page\"\norder: \"\"\nsource: \"" file_name "\"\n---\n" > introfile
                next
              }
              /^\s*\\section\{/ {
                if (outfile != "") close(outfile)
                title = gensub(/^.*\\section\{([^}]*)\}.*$/, "\\1", "g")
                slug = tolower(title)
                gsub(/[[:space:]]+/, "-", slug)
                gsub(/[^a-z0-9-]/, "", slug)
                outfile = "output/" file_name "_" slug ".md"
                print "---\ntitle: \"" title "\"\nslug: \"" slug "\"\nparent_slug: \"" parent_slug "\"\ntype: \"section\"\norder: \"\"\nsource: \"" file_name "\"\n---\n" > outfile
                next
              }
              {
                if (outfile != "") print $0 >> outfile
                else print $0 >> introfile
              }
            ' "$latest"
          done

      - name: Upload converted Markdown
        uses: actions/upload-artifact@v3
        with:
          name: markdown-pages
          path: output/
