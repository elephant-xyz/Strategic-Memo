name: convert

on:
  push:
    paths:
      - '**.tex'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc

      - name: Debug title extraction from .tex files
        run: |
          echo "ðŸ“„ Listing .tex files:"
          ls -lh *.tex
          echo "ðŸ” Extracting LaTeX titles (\\chapter{} or \\section{}):"
          grep -H -E '\\chapter\{.*\}|\\section\{.*\}' *.tex || true

      - name: Run mkdir -p output
        run: mkdir -p output

      - name: Split and Convert .tex files to Markdown
        run: |
          for file in *.tex; do
            base=$(basename "$file" .tex)
            echo "ðŸ”„ Converting $file â†’ output/${base}.md"
            pandoc "$file" -f latex -t markdown --wrap=none -o "output/${base}.md" || echo "â—ï¸Failed on $file"
          done

      - name: Combine into Full Doc
        run: |
          echo "ðŸ“š Combining all .md files into output/Full_Doc.md"
          mkdir -p output_tmp
          find output -type f -name '*.md' ! -name 'Full_Doc.md' -exec cat {} + > output_tmp/Full_Doc.md
          mv output_tmp/Full_Doc.md output/Full_Doc.md

      - name: Upload markdown output
        uses: actions/upload-artifact@v4
        with:
          name: converted-markdown
          path: output/
